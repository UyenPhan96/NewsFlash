@using Web_News.Areas.Admin.ServiceAd.AdvertisementSV
@model IEnumerable<Web_News.Areas.Admin.ViewModels.NewsViewModel>

@{
    ViewData["Title"] = "Tất cả bài viết";
    var statusFilter = ViewData["StatusF"]?.ToString();
    var pageNumber = (int)(ViewData["CurrentPage"] ?? 1);
}

<style>
    .search-form .form-control {
        flex: 1;
        min-width: 150px;
    }

    .search-form .d-flex {
        gap: 10px;
    }
</style>

<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <div class="btn-group" role="group">

                @foreach (var status in new[] { ApprovalStatus.Approved, ApprovalStatus.Rejected })
                {
                    <form method="get" action="@Url.Action("AllNews", "News")" class="m-0">
                        <input type="hidden" name="status" value="@status" />
                        <button type="submit" class="btn @(ViewData["StatusF"]?.ToString() == status.ToString() ? "btn-dark" : "btn-outline-secondary")">
                            @(status == ApprovalStatus.Approved ? "Duyệt" : "Từ chối")
                        </button>
                    </form>
                }
            </div>

            <hr />


            <form method="get" action="@Url.Action("AllNews", "News")" class="mb-3 search-form">
                <div class="d-flex flex-wrap">
                    <input type="text" name="titleSearchTerm" value="@ViewData["TitleSearchTerm"]" placeholder="Tìm kiếm theo tiêu đề" class="form-control me-2" />
                    <input type="date" name="publishDate" value="@((ViewData["PublishDate"] != null) ? ((DateTime)ViewData["PublishDate"]).ToString("yyyy-MM-dd") : string.Empty)" class="form-control me-2" />
                    <input type="text" name="authorSearchTerm" value="@ViewData["AuthorSearchTerm"]" placeholder="Tìm kiếm theo người viết" class="form-control me-2" />
                    <input type="hidden" name="status" value="@ViewData["StatusF"]" />
                    <button type="submit" class="btn btn-primary btn-sm">Tìm kiếm</button>
                </div>
            </form>


            <form method="post" asp-action="DeleteMultiple" id="deleteForm">
                @if (User.IsInRole("Admin") || User.IsInRole("Editor"))
                {
                    <button type="button" class="btn btn-danger btn-sm" onclick="confirmDeleteMultiple()">Xóa</button>

                }
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>
                                <div class="form-check form-check-danger">
                                    <label class="form-check-label">
                                        <input type="checkbox" id="selectAll" />
                                    </label>
                                </div>
                            </th>
                            <th style="font-weight: bold;">Ảnh</th>
                            <th style="font-weight: bold;">Tiêu đề</th>
                            <th style="font-weight: bold;">Ngày viết</th>
                            <th style="font-weight: bold;">Người viết</th>
                            <th style="font-weight: bold;">Thể loại</th>
                            <th style="font-weight: bold;">Trạng thái</th>
                            <th style="font-weight: bold;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <div class="form-check form-check-danger">
                                        <label class="form-check-label">
                                            <input type="checkbox" class="form-check-input" name="selectedIds" value="@item.NewsId" />
                                        </label>
                                    </div>

                                </td>
                                <td>
                                    <img src="/Images/@item.Image" style="max-width: 150px; height: auto; border-radius: 5px;" />
                                </td>
                                <td title="@item.Title">
                                    @(item.Title.Length > 45 ? item.Title.Substring(0, 45) + "..." : item.Title)
                                </td>
                                <td>@item.PublishDate.ToString("dd/MM/yyyy")</td>
                                <td>@item.CreatedByUserName</td>
                                <td>
                                    @if (item.ListCategories != null && item.ListCategories.Count > 0)
                                    {
                                        var displaycate = item.ListCategories.Take(2);
                                        foreach (var category in displaycate)
                                        {
                                            <span class="badge bg-secondary">@category.NameCategory</span>
                                        }
                                        @if (item.ListCategories.Count > 2)
                                        {
                                            <span>...</span>
                                        }
                                    }
                                </td>
                                <td>
                                    <span class="badge @(item.ApprovalStatus == ApprovalStatus.Approved ? "bg-success" : "bg-danger")">
                                        @item.ApprovalStatus.GetDisplayName()
                                    </span>
                                </td>
                                <td>
                                    <a asp-action="Details" asp-route-id="@item.NewsId" asp-route-returnUrl="@Url.Action("AllNews", new { status = ViewData["StatusF"] })" class="btn btn-info btn-sm">Xem</a>
                                    @if ((User.IsInRole("Admin") || User.IsInRole("Editor")) && item.ApprovalStatus != ApprovalStatus.Rejected)
                                    {
                                        <button type="button"
                                                class="btn btn-primary btn-sm"
                                                onclick="confirmRevoke('@Url.Action("UpdateStatus", "News", new { id = @item.NewsId })')">
                                            Thu hồi
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <div class="pagination">
                    @if (pageNumber > 1)
                    {
                        <a href="@Url.Action("AllNews", new { status = ViewData["StatusF"], pageNumber = pageNumber - 1 })" class="btn btn-outline-secondary">Lùi</a>
                    }

                    @for (int i = 1; i <= (int)ViewData["TotalPages"]; i++)
                    {
                        <a href="@Url.Action("AllNews", new { status = ViewData["StatusF"], pageNumber = i })" class="btn btn-outline-secondary @((i == pageNumber) ?  "btn-dark" : "")">@i</a>
                    }

                    @if (pageNumber < (int)ViewData["TotalPages"])
                    {
                        <a href="@Url.Action("AllNews", new { status = ViewData["StatusF"], pageNumber = pageNumber + 1 })" class="btn btn-outline-secondary">Tới</a>
                    }
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.getElementById('selectAll').onclick = function () {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function (checkbox) {
            checkbox.checked = this.checked;
        }, this);
    };


    function confirmRevoke(actionUrl) {
        Swal.fire({
            title: 'Bạn muốn thu hồi bài viết này ?',
            text: "Xem xét trước khi nhấn",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Có, thu hồi!',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {

                window.location.href = actionUrl;
            }
        });
    }


     // Hàm xác nhận xóa nhiều bài viết
    function confirmDeleteMultiple() {
        const form = document.getElementById('deleteForm');
        const selectedIds = Array.from(document.querySelectorAll('input[name="selectedIds"]:checked'));

        if (selectedIds.length === 0) {
            Swal.fire({
                title: 'Chưa chọn bài viết nào!',
                text: 'Vui lòng chọn ít nhất một bài viết để xóa.',
                icon: 'info',
                confirmButtonText: 'OK'
            });
            return;
        }

        Swal.fire({
            title: 'Bạn có chắc chắn?',
            text: `Bạn sẽ xóa ${selectedIds.length} bài viết đã chọn.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Có, xóa!',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                form.submit(); // Gửi form để thực hiện xóa
            }
        });
    }

    // Hàm xác nhận xóa một bài viết
    function confirmDeleteSingle(actionUrl) {
        Swal.fire({
            title: 'Bạn có chắc chắn?',
            text: "Bài viết sẽ bị xóa và không thể khôi phục.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Có, xóa!',
            cancelButtonText: 'Hủy'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = actionUrl;
            }
        });
    }
</script>