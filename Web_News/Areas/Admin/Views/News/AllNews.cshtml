@using Web_News.Areas.Admin.ServiceAd.AdvertisementSV
@model IEnumerable<Web_News.Areas.Admin.ViewModels.NewsViewModel>

@{
    ViewData["Title"] = "All News";
    var statusFilter = ViewData["StatusF"]?.ToString();
    var pageNumber = (int)(ViewData["CurrentPage"] ?? 1);
}

<style>
    .search-form .form-control {
        flex: 1;
        min-width: 150px;
    }
    .search-form .d-flex {
        gap: 10px;
    }
</style>

<div class="col-lg-12 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <div class="btn-group" role="group">
                @* Nút lọc theo trạng thái *@
                @foreach (var status in new[] { ApprovalStatus.Approved, ApprovalStatus.Rejected })
                {
                    <form method="get" action="@Url.Action("AllNews", "News")" class="m-0">
                        <input type="hidden" name="status" value="@status" />
                        <button type="submit" class="btn @(ViewData["StatusF"]?.ToString() == status.ToString() ? "btn-dark" : "btn-outline-secondary")">
                            @(status == ApprovalStatus.Approved ? "Duyệt" : "Từ chối")
                        </button>
                    </form>
                }
            </div>
          
            <hr />
           
            <!-- Form tìm kiếm -->
            <form method="get" action="@Url.Action("AllNews", "News")" class="mb-3 search-form">
                <div class="d-flex flex-wrap">
                    <input type="text" name="titleSearchTerm" value="@ViewData["TitleSearchTerm"]" placeholder="Tìm kiếm theo tiêu đề" class="form-control me-2" />
                    <input type="date" name="publishDate" value="@((ViewData["PublishDate"] != null) ? ((DateTime)ViewData["PublishDate"]).ToString("yyyy-MM-dd") : string.Empty)" class="form-control me-2" />
                    <input type="text" name="authorSearchTerm" value="@ViewData["AuthorSearchTerm"]" placeholder="Tìm kiếm theo người viết" class="form-control me-2" />
                    <input type="hidden" name="status" value="@ViewData["StatusF"]" />
                    <button type="submit" class="btn btn-primary btn-sm">Tìm kiếm</button>
                </div>
            </form>

            <!-- Form hiển thị danh sách và xóa  -->
            <form method="post" asp-action="DeleteMultiple" id="deleteForm">
                @if (User.IsInRole("Admin") || User.IsInRole("Editor"))
                {
                    <button type="submit" class="btn btn-danger btn-sm">Xóa</button>
                }
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>
                                <div class="form-check form-check-danger">
                                    <label class="form-check-label">
                                        <input type="checkbox" id="selectAll"
                                    </label>
                                </div>
                            </th>
                            <th style="font-weight: bold;">Ảnh</th>
                            <th style="font-weight: bold;">Tiêu đề</th>
                            <th style="font-weight: bold;">Ngày viết</th>
                            <th style="font-weight: bold;">Người viết</th>
                            <th style="font-weight: bold;">Thể loại</th>
                            <th style="font-weight: bold;">Trạng thái</th>
                            <th style="font-weight: bold;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td>
                                    <div class="form-check form-check-danger">
                                        <label class="form-check-label">
                                            <input type="checkbox" class="form-check-input" name="selectedIds" value="@item.NewsId" />
                                        </label>
                                    </div>
                                   
                                </td>
                                <td>
                                    <img src="/Images/@item.Image" style="max-width: 150px; height: auto; border-radius: 5px;" />
                                </td>
                                <td title="@item.Title">
                                    @(item.Title.Length > 45 ? item.Title.Substring(0, 45) + "..." : item.Title)
                                </td>
                                <td>@item.PublishDate.ToString("dd/MM/yyyy")</td>
                                <td>@item.CreatedByUserName</td>
                                <td>
                                    @if (item.ListCategories != null && item.ListCategories.Count > 0)
                                    {
                                        var displaycate = item.ListCategories.Take(2);
                                        foreach (var category in displaycate)
                                        {
                                            <span class="badge bg-secondary">@category.NameCategory</span>
                                        }
                                        @if (item.ListCategories.Count > 2)
                                        {
                                            <span>...</span>
                                        }
                                    }
                                </td>
                                <td>
                                    <span class="badge @(item.ApprovalStatus == ApprovalStatus.Approved ? "bg-success" : "bg-danger")">
                                        @item.ApprovalStatus.GetDisplayName()
                                    </span>
                                </td>
                                <td>
                                    <a asp-action="Details" asp-route-id="@item.NewsId" asp-route-returnUrl="@Url.Action("AllNews", new { status = ViewData["StatusF"] })" class="btn btn-info btn-sm">Xem</a>
                                    @if ((User.IsInRole("Admin") || User.IsInRole("Editor")) && item.ApprovalStatus != ApprovalStatus.Rejected)
                                    {
                                        <a asp-action="UpdateStatus" asp-route-id="@item.NewsId" class="btn btn-primary btn-sm">Thu hồi</a> 
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

                <!-- Phân trang -->
                <div class="pagination">
                    @if (pageNumber > 1)
                    {
                        <a href="@Url.Action("AllNews", new { status = ViewData["StatusF"], pageNumber = pageNumber - 1 })" class="btn btn-outline-secondary">Lùi</a>
                    }

                    @for (int i = 1; i <= (int)ViewData["TotalPages"]; i++)
                    {
                        <a href="@Url.Action("AllNews", new { status = ViewData["StatusF"], pageNumber = i })" class="btn btn-outline-secondary @((i == pageNumber) ?  "btn-dark" : "")">@i</a>
                    }

                    @if (pageNumber < (int)ViewData["TotalPages"])
                    {
                        <a href="@Url.Action("AllNews", new { status = ViewData["StatusF"], pageNumber = pageNumber + 1 })"class="btn btn-outline-secondary">Tới</a>
                    }
                </div>
            </form>    
        </div>
    </div>
</div>

<script>
    document.getElementById('selectAll').onclick = function () {
        var checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function (checkbox) {
            checkbox.checked = this.checked;
        }, this);
    };
</script>